
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Seplog</title>
<meta name="description" content="Documentation of Coq module Seplog" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Seplog</h1>
<div class="coq">
<div class="doc">Separation logic. </div>
<br/>
<span class="id">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.ZArith.ZArith.html">ZArith</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.micromega.Lia.html">Lia</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html">Bool</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html">List</a></span> <span class="id">Program.Equality</span>.<br/>
<span class="id">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">FunctionalExtensionality</span> <span class="id">PropExtensionality</span>.<br/>
<span class="id">From</span> <span class="id">CDF</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Sequences</span> <span class="id">Separation</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">Z_scope</span>.<br/>
<br/>
<h1> 1. A language of pointers </h1>
<br/>
<div class="doc">We now define a small programming language to work with pointers to
    mutable state.  The language has variables, but these variables are
    immutable.  This in unlike IMP but like ML: mutable variables are
    expressed as immutable pointers (references) to mutable state. </div>
<br/>
<div class="doc">As in ML too, we blur the distinction between expressions and commands.
    Every command returns a value, which we take to be an integer,
    in addition to possibly performing effects. </div>
<br/>
<div class="doc">We use higher-order abstract syntax to represent commands in this
    language.  With first-order abstract syntax, a "let" binding
    <span class="bracket"><span class="kwd">let</span> <span class="id">x</span> = <span class="id">a</span> <span class="kwd">in</span> <span class="id">b</span></span> would be represented using the constructor 
<pre>
    LET: forall (x: ident) (a b: com), com</pre>
    With higher-order syntax, we use a Coq function <span class="bracket"><span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">b</span></span> to
    represent the binding of <span class="bracket"><span class="id">x</span></span> inside <span class="bracket"><span class="id">b</span></span>:
<pre>
    LET: forall (a: com) (b: Z -&gt; com), com</pre>
    As a benefit, we can use any Coq expression of type <span class="bracket"><span class="id">Z</span></span> as a
    pure command of the language, making it unnecessary to define
    syntax and semantics for a specific expression language.
</div>
<br/>
<span class="kwd">CoInductive</span> <span class="id"><a name="PURE">com</a></span>: <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">PURE</span> (<span class="id">x</span>: <span class="id">Z</span>)                         <span class="docright">(* command without effects  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">LET</a></span> (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">f</span>: <span class="id">Z</span> -&gt; <span class="id">com</span>)          <span class="docright">(* sequencing of commands  *)</span><br/>
&nbsp;&nbsp;| <span class="id">IFTHENELSE</span> (<span class="id">b</span>: <span class="id">Z</span>) (<span class="id">c1</span> <span class="id">c2</span>: <span class="id">com</span>)      <span class="docright">(* conditional  *)</span><br/>
&nbsp;&nbsp;| <span class="id">ALLOC</span> (<span class="id">sz</span>: <span class="id">nat</span>)                     <span class="docright">(* allocate <span class="bracket"><span class="id">sz</span></span> words of storage  *)</span><br/>
&nbsp;&nbsp;| <span class="id">GET</span> (<span class="id">l</span>: <span class="id">addr</span>)                       <span class="docright">(* dereference a pointer  *)</span><br/>
&nbsp;&nbsp;| <span class="id">SET</span> (<span class="id">l</span>: <span class="id">addr</span>) (<span class="id">v</span>: <span class="id">Z</span>)                <span class="docright">(* assign through a pointer  *)</span><br/>
&nbsp;&nbsp;| <span class="id">FREE</span> (<span class="id">l</span>: <span class="id">addr</span>)                      <span class="docright">(* free one word of storage  *)</span><br/>
&nbsp;&nbsp;| <span class="id">PICK</span> (<span class="id">n</span>: <span class="id">Z</span>).                        <span class="docright">(* pick a number between 0 and <span class="bracket"><span class="id">n</span></span>  *)</span><br/>
<br/>
<div class="doc">Some derived forms. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">SKIP</span>: <span class="id">com</span> := <span class="id">PURE</span> 0.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">SEQ</span> (<span class="id">c1</span> <span class="id">c2</span>: <span class="id">com</span>) := <span class="id">LET</span> <span class="id">c1</span> (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id"><a name="EITHER">c2</a></span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">EITHER</span> (<span class="id">c1</span> <span class="id"><a href="CDF.Seplog.html#PICK">c2</a></span>: <span class="id">com</span>) := <span class="id">LET</span> (<span class="id">PICK</span> 2) (<span class="kwd">fun</span> <span class="id">n</span> =&gt; <span class="id">IFTHENELSE</span> <span class="id">n</span> <span class="id">c1</span> <span class="id">c2</span>).<br/>
<br/>
<div class="doc">Reduction semantics. </div>
<br/>
<span class="kwd">Inductive</span> <span class="tactic">red</span>: <span class="id">com</span> * <span class="id">heap</span> -&gt; <span class="id">com</span> * <span class="id">heap</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">red_pick</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">i</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">PICK</span> <span class="id">n</span>, <span class="id">h</span>) (<span class="id">PURE</span> <span class="id">i</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_let_done</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">f</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">LET</span> (<span class="id">PURE</span> <span class="id">x</span>) <span class="id">f</span>, <span class="id">h</span>) (<span class="id">f</span> <span class="id">x</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_let_step</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> <span class="id">h</span> <span class="id">c</span>' <span class="id">h</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c</span>', <span class="id">h</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">LET</span> <span class="id">c</span> <span class="id">f</span>, <span class="id">h</span>) (<span class="id">LET</span> <span class="id">c</span>' <span class="id">f</span>, <span class="id">h</span>')<br/>
&nbsp;&nbsp;| <span class="id">red_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id"><a href="CDF.Seplog.html#IFTHENELSE">c2</a></span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>) ((<span class="kwd">if</span> <span class="id">b</span> =? 0 <span class="kwd">then</span> <span class="id">c2</span> <span class="kwd">else</span> <span class="id">c1</span>), <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_alloc</span>: <span class="kwd">forall</span> <span class="id">sz</span> (<span class="id">h</span>: <span class="id">heap</span>) <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">i</span>, <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> -&gt; <span class="id">h</span> <span class="id">i</span> = <span class="id">None</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">l</span> &lt;&gt; 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">ALLOC</span> <span class="id">sz</span>, <span class="id">h</span>) (<span class="id">PURE</span> <span class="id">l</span>, <span class="id">hinit</span> <span class="id">l</span> <span class="id">sz</span> <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_get</span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id">heap</span>) <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">GET</span> <span class="id">l</span>, <span class="id">h</span>) (<span class="id">PURE</span> <span class="id">v</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_set</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> (<span class="id">h</span>: <span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">SET</span> <span class="id">l</span> <span class="id">v</span>, <span class="id">h</span>) (<span class="id">SKIP</span>, <span class="id">hupdate</span> <span class="id">l</span> <span class="id">v</span> <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">red_free</span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">FREE</span> <span class="id">l</span>, <span class="id">h</span>) (<span class="id">SKIP</span>, <span class="id">hfree</span> <span class="id">l</span> <span class="id">h</span>).<br/>
<br/>
<div class="doc">Absence of run-time errors. <span class="bracket"><span class="id">immsafe</span> <span class="id">c</span> <span class="id">h</span></span> holds if <span class="bracket"><span class="id">c</span> / <span class="id">h</span></span> is not
    going to abort immediately on a run-time error, such as dereferencing 
    an invalid pointer. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id">immsafe</span>: <span class="id">com</span> * <span class="id">heap</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">immsafe_pure</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">PURE</span> <span class="id">v</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_let</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">h</span>) -&gt; <span class="id">immsafe</span> (<span class="id">LET</span> <span class="id">c</span> <span class="id">f</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_alloc</span>: <span class="kwd">forall</span> <span class="id">sz</span> (<span class="id">h</span>: <span class="id">heap</span>) <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">l</span> &lt;&gt; 0 -&gt; (<span class="kwd">forall</span> <span class="id">i</span>, <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> -&gt; <span class="id">h</span> <span class="id">i</span> = <span class="id">None</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id"><a name="immsafe_get">ALLOC</a></span> <span class="id">sz</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_get</span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="CDF.Seplog.html#GET">None</a></span> -&gt; <span class="id">immsafe</span> (<span class="id">GET</span> <span class="id">l</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_set</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> (<span class="id">h</span>: <span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="CDF.Seplog.html#SET">None</a></span> -&gt; <span class="id">immsafe</span> (<span class="id">SET</span> <span class="id">l</span> <span class="id">v</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_free</span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="CDF.Seplog.html#FREE">None</a></span> -&gt; <span class="id">immsafe</span> (<span class="id">FREE</span> <span class="id">l</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id">immsafe_pick</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">PICK</span> <span class="id">n</span>, <span class="id">h</span>).<br/>
<br/>
<h1> 2.  The rules of separation logic </h1>
<br/>
<span class="kwd">Definition</span> <span class="id">precond</span> := <span class="id">assertion</span>.<br/>
<span class="kwd">Definition</span> <span class="id"><a href="CDF.Separation.html#assertion">postcond</a></span> := <span class="id">Z</span> -&gt; <span class="id">assertion</span>.<br/>
<br/>
<h2> 2.1.  Semantic definition of strong triples </h2>
<br/>
<div class="doc">Instead of axiomatizing the rules of separation logic, then prove
    their soundness against the operational semantics, we define
    triples <span class="bracket"> ⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ </span> directly in terms of the
    operational semantics, then show the rules of separation logic as
    lemmas about these semantic triples.
    Note: the way triples are defined below, they are strong triples
    that guarantee termination.  However, we write them with braces
    instead of brackets, for consistency with the third lecture
    and with the literature on separation logic.
 </div>
<br/>
<div class="doc"><span class="bracket"><span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span></span> holds if <span class="bracket"><span class="id">c</span></span> started in <span class="bracket"><span class="id">h</span></span> always terminates without errors,
    and when it terminates with value <span class="bracket"><span class="id">v</span></span>, the postcondition <span class="bracket"><span class="id">Q</span> <span class="id">v</span></span> holds
    of the final heap. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id">safe</span>: <span class="id">com</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">postcond</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">safe_done</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">Q</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Q</span> <span class="id">v</span> <span class="id"><a href="CDF.Seplog.html#PURE">h</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">safe</span> (<span class="id">PURE</span> <span class="id">v</span>) <span class="id">h</span> <span class="id">Q</span><br/>
&nbsp;&nbsp;| <span class="id">safe_step</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#False">c</a></span> <span class="kwd">with</span> <span class="id">PURE</span> <span class="id">_</span> =&gt; <span class="id">False</span> | <span class="id">_</span> =&gt; <span class="id">True</span> <span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">h</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">c</span>' <span class="id">h</span>', <span class="tactic">red</span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c</span>', <span class="id">h</span>') -&gt; <span class="id">safe</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">Q</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>.<br/>
<br/>
<div class="doc">We define semantic triples like we did for Hoare logic: </div>
<br/>
<span class="kwd">Definition</span> <span class="id">triple</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">Q</span>: <span class="id">postcond</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h</span>, <span class="id">P</span> <span class="id">h</span> -&gt; <span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>.<br/>
<br/>
<span class="kwd">Notation</span> "⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄" := (<span class="id">triple</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>) (<span class="tactic">at</span> <span class="id">level</span> 90, <span class="id">c</span> <span class="tactic">at</span> <span class="id">next</span> <span class="id">level</span>).<br/>
<br/>
<h2> 2.2. The frame rule </h2>
<br/>
<div class="doc">The frame rule is valid because the operational semantics has nice
    properties with respect to heap extension: if a command is safe
    in a small heap, it is safe in a bigger heap, and any reduction
    from the bigger heap is simulated by a reduction from the smaller heap. </div>
<br/>
<span class="kwd">Ltac</span> <span class="id">inv</span> <span class="id">H</span> := <span class="tactic">inversion</span> <span class="id">H</span>; <span class="tactic">clear</span> <span class="id">H</span>; <span class="tactic">subst</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">immsafe_frame</span>: <span class="kwd">forall</span> <span class="id">h</span>' <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">h</span>) -&gt; <span class="id">hdisjoint</span> <span class="id">h</span> <span class="id">h</span>' -&gt; <span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">hunion</span> <span class="id">h</span> <span class="id">h</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof110')">Proof.</div>
<div class="proofscript" id="proof110">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span>' <span class="id">c</span> <span class="id">h</span> <span class="id">IMM</span>; <span class="tactic">dependent</span> <span class="tactic">induction</span> <span class="id">IMM</span>; <span class="tactic">intros</span> <span class="id">DISJ</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">destruct</span> (<span class="id">isfinite</span> (<span class="id">hunion</span> <span class="id">h</span> <span class="id">h</span>')) <span class="kwd">as</span> [<span class="id">l</span>' <span class="id">FIN</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">immsafe_alloc</span> <span class="kwd">with</span> (<span class="id">Z.max</span> 1 <span class="id">l</span>').<br/>
&nbsp;&nbsp;<span class="id">lia</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">FIN</span>. <span class="id">lia</span>.<br/>
- <span class="id">constructor</span>. <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">h</span> <span class="id">l</span>); <span class="tactic">congruence</span>. <br/>
- <span class="id">constructor</span>. <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">h</span> <span class="id">l</span>); <span class="tactic">congruence</span>. <br/>
- <span class="id">constructor</span>. <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">h</span> <span class="id">l</span>); <span class="tactic">congruence</span>. <br/>
- <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">red_frame</span>: <span class="kwd">forall</span> <span class="id">h2</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">c</span>' <span class="id">h</span>',<br/>
&nbsp;&nbsp;<span class="tactic">red</span> (<span class="id">c</span>, <span class="id">hunion</span> <span class="id">h1</span> <span class="id">h2</span>) (<span class="id">c</span>', <span class="id">h</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">h1</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">hdisjoint</span> <span class="id">h1</span> <span class="id">h2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">h1</span>', <span class="tactic">red</span> (<span class="id"><a href="CDF.Separation.html#sepconj_assoc">c</a></span>, <span class="id">h1</span>) (<span class="id">c</span>', <span class="id">h1</span>') /\ <span class="id">hdisjoint</span> <span class="id">h1</span>' <span class="id">h2</span> /\ <span class="id">h</span>' = <span class="id">hunion</span> <span class="id">h1</span>' <span class="id">h2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof111')">Proof.</div>
<div class="proofscript" id="proof111">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">h</span>'; <span class="tactic">intros</span> <span class="id">RED</span>; <span class="tactic">dependent</span> <span class="tactic">induction</span> <span class="id">RED</span>; <span class="tactic">intros</span> <span class="id">IMM</span> <span class="id">DISJ</span>; <span class="id">inv</span> <span class="id">IMM</span>.<br/>
- <span class="id">exists</span> <span class="id">h1</span>; <span class="tactic">intuition</span> <span class="tactic">auto</span>. <span class="id"><a href="CDF.Seplog.html#GET">constructor</a></span>; <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> <span class="id">h1</span>; <span class="tactic">intuition</span> <span class="tactic">auto</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">edestruct</span> <span class="id">IHRED</span> <span class="kwd">as</span> (<span class="id">h1</span>' &amp; <span class="id">R</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">h1</span>'; <span class="tactic">intuition</span> <span class="tactic">auto</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> <span class="id">h1</span>; <span class="tactic">intuition</span> <span class="tactic">auto</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> (<span class="id">hinit</span> <span class="id">l</span> <span class="id">sz</span> <span class="id">h1</span>); <span class="tactic">intuition</span> <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">destruct</span> (<span class="id">h1</span> <span class="id">i</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">red</span>; <span class="id">cbn</span>; <span class="tactic">intros</span> <span class="id">i</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">EITHER</span>: <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> \/ (<span class="id">i</span> &lt; <span class="id">l</span> \/ <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> &lt;= <span class="id">i</span>)) <span class="tactic">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">EITHER</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">right</span>. <span class="tactic">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">destruct</span> (<span class="id">h1</span> <span class="id">i</span>), (<span class="id">h2</span> <span class="id">i</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> <span class="id">hinit_outside</span> <span class="tactic">by</span> <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">DISJ</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">i</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">EITHER</span>: <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> \/ (<span class="id">i</span> &lt; <span class="id">l</span> \/ <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> &lt;= <span class="id">i</span>)) <span class="tactic">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">EITHER</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> ! <span class="id">hinit_inside</span> <span class="tactic">by</span> <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> ! <span class="id">hinit_outside</span> <span class="tactic">by</span> <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> <span class="id">h1</span>; <span class="tactic">intuition</span> <span class="tactic">auto</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">h1</span> <span class="id">l</span>); <span class="tactic">congruence</span>.<br/>
- <span class="id">exists</span> (<span class="id">hupdate</span> <span class="id">l</span> <span class="id">v</span> <span class="id">h1</span>); <span class="tactic">intuition</span> <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">i</span>; <span class="id">cbn</span>. <span class="tactic">generalize</span> (<span class="id">DISJ</span> <span class="id">i</span>). <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">i</span>); <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">i</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">i</span>); <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> (<span class="id">hfree</span> <span class="id">l</span> <span class="id">h1</span>); <span class="tactic">intuition</span> <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">i</span>; <span class="id">cbn</span>. <span class="tactic">generalize</span> (<span class="id">DISJ</span> <span class="id">i</span>). <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">i</span>); <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">i</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">i</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">i</span>. <span class="tactic">generalize</span> (<span class="id">DISJ</span> <span class="id">l</span>). <span class="tactic">intuition</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_frame</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">R</span>: <span class="id">assertion</span>) <span class="id">h</span>', <span class="id">R</span> <span class="id">h</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hinit">safe</a></span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> -&gt; <span class="id">hdisjoint</span> <span class="id">h</span> <span class="id">h</span>' -&gt; <span class="id">safe</span> <span class="id">c</span> (<span class="id">hunion</span> <span class="id">h</span> <span class="id">h</span>') (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof112')">Proof.</div>
<div class="proofscript" id="proof112">
&nbsp;&nbsp;<span class="tactic">induction</span> 2; <span class="tactic">intros</span> <span class="id">DISJ</span>.<br/>
- <span class="id">constructor</span>. <span class="id">exists</span> <span class="id">h</span>, <span class="id">h</span>'; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">immsafe_frame</span>; <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">edestruct</span> <span class="id">red_frame</span> <span class="kwd">as</span> (<span class="id">h1</span>' &amp; <span class="id">RED1</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>); <span class="tactic">eauto</span>. <span class="tactic">subst</span> <span class="id">h</span>'0.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H3</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_frame</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id"><a href="CDF.Separation.html#emp">P</a></span> ** <span class="id">R</span> ⦄ <span class="id">c</span> ⦃ <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof113')">Proof.</div>
<div class="proofscript" id="proof113">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">R</span> <span class="id">TR</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">P1</span> &amp; <span class="id">R2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>). <span class="tactic">subst</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">safe_frame</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 2.3. The "small rules" for heap operations </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_get</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ⦄ <span class="id">GET</span> <span class="id">l</span> ⦃ <span class="kwd">fun</span> <span class="id">v</span>' =&gt; (<span class="id">v</span>' = <span class="id">v</span>) //\\ <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof114')">Proof.</div>
<div class="proofscript" id="proof114">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">v</span> <span class="id">h</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">P</span>. <span class="tactic">subst</span> <span class="id">h</span>. <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">constructor</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>. <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_set</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">valid</span> <span class="id">l</span> ⦄ <span class="id">SET</span> <span class="id">l</span> <span class="id">v</span> ⦃ <span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof115')">Proof.</div>
<div class="proofscript" id="proof115">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">v0</span> &amp; <span class="id">P</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">P</span>; <span class="tactic">subst</span> <span class="id">h</span>; <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">constructor</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>. <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span> <span class="kwd">in</span> <span class="id">P</span>; <span class="tactic">subst</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>. <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">l</span>'; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">l</span>'); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">valid_N</span> (<span class="id">l</span>: <span class="id">addr</span>) (<span class="id">sz</span>: <span class="id">nat</span>) : <span class="id">assertion</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">sz</span> <span class="kwd">with</span> <span class="id">O</span> =&gt; <span class="id">emp</span> | <span class="id">S</span> <span class="id">sz</span> =&gt; <span class="id">valid</span> <span class="id">l</span> ** <span class="id">valid_N</span> (<span class="id">l</span> + 1) <span class="id">sz</span> <span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">valid_N_init</span>: <span class="kwd">forall</span> <span class="id">sz</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;(<span class="id">valid_N</span> <span class="id">l</span> <span class="id">sz</span>) (<span class="id">hinit</span> <span class="id">l</span> <span class="id">sz</span> <span class="id">hempty</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof116')">Proof.</div>
<div class="proofscript" id="proof116">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">sz</span> <span class="kwd">as</span> [ | <span class="id">sz</span>]; <span class="tactic">intros</span> <span class="id">l</span>; <span class="id">cbn</span>.<br/>
- <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">exists</span> (<span class="id">hupdate</span> <span class="id">l</span> 0 <span class="id">hempty</span>), (<span class="id">hinit</span> (<span class="id">l</span> + 1) <span class="id">sz</span> <span class="id">hempty</span>); <span class="tactic">intuition</span> <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">exists</span> 0. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">x</span>. <span class="tactic">unfold</span> <span class="id">hupdate</span>, <span class="id">hempty</span>; <span class="id"><a href="CDF.Seplog.html#immsafe">cbn</a></span>. <span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="tactic">rewrite</span> <span class="id">hinit_outside</span> <span class="tactic">by</span> <span class="id">lia</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">x</span>. <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id"><a href="CDF.Seplog.html#safe">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_alloc</span>: <span class="kwd">forall</span> <span class="id">sz</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">emp</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">ALLOC</span> <span class="id">sz</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">l</span> =&gt; (<span class="id">l</span> &lt;&gt; 0) //\\ <span class="id">valid_N</span> <span class="id">l</span> <span class="id">sz</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof117')">Proof.</div>
<div class="proofscript" id="proof117">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">sz</span> <span class="id">h</span> <span class="id">P</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">P</span>. <span class="tactic">subst</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">apply</span> <span class="id">immsafe_alloc</span> <span class="kwd">with</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;+ <span class="id">lia</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">auto</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">valid_N_init</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_free</span>: <span class="kwd">forall</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">valid</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">FREE</span> <span class="id">l</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">emp</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof118')">Proof.</div>
<div class="proofscript" id="proof118">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">h</span> (<span class="id">v0</span> &amp; <span class="id">P</span>). <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">subst</span> <span class="id">h</span>. <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>. <span class="tactic">congruence</span>. <br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>. <span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">x</span>. <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 2.4. Properties of the <span class="bracket"><span class="id">safe</span></span> predicate </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_pure</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">h</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">safe</span> (<span class="id">PURE</span> <span class="id">v</span>) <span class="id">h</span> <span class="id"><a href="CDF.Seplog.html#Hoare">Q</a></span> -&gt; <span class="id">Q</span> <span class="id">v</span> <span class="id"><a href="CDF.Seplog.html#PURE">h</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof119')">Proof.</div>
<div class="proofscript" id="proof119">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>. <br/>
- <span class="tactic">auto</span>.<br/>
- <span class="id">contradiction</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_red</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">c</span>' <span class="id">h</span>',<br/>
&nbsp;&nbsp;<span class="id">safe</span>  <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> -&gt; <span class="tactic">red</span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c</span>', <span class="id">h</span>') -&gt; <span class="id">safe</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof120')">Proof.</div>
<div class="proofscript" id="proof120">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
- <span class="id">inv</span> <span class="id">H0</span>.<br/>
- <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_immsafe</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> -&gt; <span class="id">immsafe</span> (<span class="id">c</span>, <span class="id">h</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof121')">Proof.</div>
<div class="proofscript" id="proof121">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_let</span>: <span class="kwd">forall</span> (<span class="id">Q</span> <span class="id">R</span>: <span class="id">postcond</span>) <span class="id">f</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id"><a href="CDF.Seplog.html#LET">v</a></span> <span class="id">h</span>', <span class="id">Q</span> <span class="id">v</span> <span class="id">h</span>' -&gt; <span class="id">safe</span> (<span class="id">f</span> <span class="id">v</span>) <span class="id">h</span>' <span class="id">R</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">safe</span> (<span class="id">LET</span> <span class="id">c</span> <span class="id">f</span>) <span class="id">h</span> <span class="id">R</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof122')">Proof.</div>
<div class="proofscript" id="proof122">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Q</span> <span class="id">R</span> <span class="id">f</span> <span class="id">POST</span>. <span class="tactic">induction</span> 1.<br/>
- <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>. <span class="id"><a href="CDF.Seplog.html#postcond">constructor</a></span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="tactic">apply</span> <span class="id">POST</span>; <span class="tactic">auto</span>. <span class="id">inv</span> <span class="id">H1</span>.<br/>
- <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">contradiction</span>. <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">safe_consequence</span>: <span class="kwd">forall</span> (<span class="id">Q</span> <span class="id">Q</span>': <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span> <span class="id">v</span> --&gt;&gt; <span class="id">Q</span>' <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span>, <span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> -&gt; <span class="id"><a href="CDF.Seplog.html#Hoare">safe</a></span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof123')">Proof.</div>
<div class="proofscript" id="proof123">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Q</span> <span class="id">Q</span>' <span class="id"><a href="CDF.Seplog.html#Hoare">IMP</a></span>. <span class="tactic">induction</span> 1.<br/>
- <span class="tactic">apply</span> <span class="id">safe_done</span>. <span class="tactic">apply</span> <span class="id">IMP</span>. <span class="tactic">assumption</span>.<br/>
- <span class="tactic">apply</span> <span class="id">safe_step</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 2.5. Rules for control structures </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_pure</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">v</span> (<span class="id">Q</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">PURE</span> <span class="id">v</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof124')">Proof.</div>
<div class="proofscript" id="proof124">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">intros</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id">H</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_let</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">Q</span> <span class="id">R</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, ⦃ <span class="id">Q</span> <span class="id">v</span> ⦄ <span class="id">f</span> <span class="id">v</span> ⦃ <span class="id">R</span> ⦄) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">LET</span> <span class="id">c</span> <span class="id">f</span> ⦃ <span class="id">R</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof125')">Proof.</div>
<div class="proofscript" id="proof125">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">R</span>; <span class="tactic">intros</span> <span class="id">HR1</span> <span class="id">HR2</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">safe_let</span> <span class="kwd">with</span> <span class="id">Q</span>. <span class="tactic">apply</span> <span class="id">HR2</span>. <span class="tactic">apply</span> <span class="id">HR1</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ (<span class="id">b</span> &lt;&gt; 0) //\\ <span class="id">P</span> ⦄ <span class="id">c1</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ (<span class="id">b</span> = 0) //\\ <span class="id">P</span> ⦄ <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof126')">Proof.</div>
<div class="proofscript" id="proof126">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">Q</span>; <span class="tactic">intros</span> <span class="id">HR1</span> <span class="id">HR2</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="tactic">destruct</span> (<span class="id">Z.eqb_spec</span> <span class="id">b</span> 0).<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">HR2</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">HR1</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_consequence</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>' <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span>' ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">P</span>' -&gt; (<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span>' <span class="id">v</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof127')">Proof.</div>
<div class="proofscript" id="proof127">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">safe_consequence</span> <span class="kwd">with</span> <span class="id">Q</span>'; <span class="tactic">auto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_pick</span>: <span class="kwd">forall</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">emp</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">PICK</span> <span class="id">n</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">i</span> =&gt; <span class="id">pure</span> (0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof128')">Proof.</div>
<div class="proofscript" id="proof128">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id"><a href="CDF.Separation.html#pure">constructor</a></span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 2.6.  Useful derived rules </h2>
<br/>
<div class="doc">The following rules are heavily used in the examples of section 3. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_consequence_pre</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">P</span>' -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof129')">Proof.</div>
<div class="proofscript" id="proof129">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">triple_consequence</span> <span class="kwd">with</span> <span class="id">P</span>' <span class="id">Q</span>; <span class="tactic">auto</span>. <span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_consequence_post</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">Q</span>',<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span>' ⦄ -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span>' <span class="id">v</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof130')">Proof.</div>
<div class="proofscript" id="proof130">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">triple_consequence</span> <span class="kwd">with</span> <span class="id">P</span> <span class="id">Q</span>'; <span class="tactic">auto</span>. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_lift_pure</span>: <span class="kwd">forall</span> (<span class="id">P</span>: <span class="kwd">Prop</span>) <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;(<span class="id">P</span> -&gt; ⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> //\\ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof131')">Proof.</div>
<div class="proofscript" id="proof131">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">intros</span> <span class="id">h</span> [<span class="id">P1</span> <span class="id">P2</span>]. <span class="tactic">apply</span> <span class="id">H</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_lift_exists</span>: <span class="kwd">forall</span> (<span class="id">X</span>: <span class="kwd">Type</span>) (<span class="id">P</span>: <span class="id">X</span> -&gt; <span class="id">assertion</span>) <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>, ⦃ <span class="id">P</span> <span class="id">x</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">aexists</span> <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof132')">Proof.</div>
<div class="proofscript" id="proof132">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">intros</span> <span class="id">h</span> (<span class="id">x</span> &amp; <span class="id">Px</span>). <span class="tactic">apply</span> (<span class="id">H</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_ifthen</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">b</span> &lt;&gt; 0 -&gt; ⦃ <span class="id">P</span> ⦄ <span class="id">c1</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof133')">Proof.</div>
<div class="proofscript" id="proof133">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">triple_ifthenelse</span>; <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="id">lia</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_ifelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">b</span> = 0 -&gt; ⦃ <span class="id">P</span> ⦄ <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof134')">Proof.</div>
<div class="proofscript" id="proof134">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">triple_ifthenelse</span>; <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span>.<br/>
- <span class="id">lia</span>.<br/>
- <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">unroll_com</span>: <span class="kwd">forall</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">c</span> = <span class="kwd">match</span> <span class="id">c</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">PURE</span> <span class="id">x</span> =&gt; <span class="id">PURE</span> <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">LET</span> <span class="id">c</span> <span class="id">f</span> =&gt; <span class="id">LET</span> <span class="id">c</span> <span class="id">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> =&gt; <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="CDF.Seplog.html#IFTHENELSE">ALLOC</a></span> <span class="id">sz</span> =&gt; <span class="id">ALLOC</span> <span class="id">sz</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">GET</span> <span class="id">l</span> =&gt; <span class="id">GET</span> <span class="id">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">SET</span> <span class="id">l</span> <span class="id">v</span> =&gt; <span class="id">SET</span> <span class="id">l</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">FREE</span> <span class="id">l</span> =&gt; <span class="id">FREE</span> <span class="id">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">PICK</span> <span class="id">n</span> =&gt; <span class="id">PICK</span> <span class="id">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof135')">Proof.</div>
<div class="proofscript" id="proof135">
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">c</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h1> 3. Singly-linked lists </h1>
<br/>
<h2> Representation predicate </h2>
<br/>
<div class="doc">Here is a separation logic assertion that describes the in-memory
    representation of a list.
<ul>
<li>
   <span class="bracket"><span class="id">a</span></span> is the pointer to the list head (or 0 if the list is empty).
</li>
<li>
   <span class="bracket"><span class="id">l</span></span> is the Coq list of the list elements.
</li>
</ul>
</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">list_at</span> (<span class="id">a</span>: <span class="id">addr</span>) (<span class="id">l</span>: <span class="id">list</span> <span class="id">Z</span>) : <span class="id">assertion</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span> =&gt; (<span class="id">a</span> = 0) //\\ <span class="id">emp</span><br/>
&nbsp;&nbsp;| <span class="id">h</span> :: <span class="id">t</span> =&gt; (<span class="id">a</span> &lt;&gt; 0) //\\ <span class="id">aexists</span> (<span class="kwd">fun</span> <span class="id">a</span>' =&gt; <span class="id">contains</span> <span class="id">a</span> <span class="id">h</span> ** <span class="id">contains</span> (<span class="id">a</span> + 1) <span class="id">a</span>' ** <span class="id">list_at</span> <span class="id">a</span>' <span class="id">t</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<h2> The "cons" operation </h2>
<br/>
<span class="kwd">Definition</span> <span class="id">list_cons</span> (<span class="id">n</span>: <span class="id">Z</span>) (<span class="id">a</span>: <span class="id">addr</span>) : <span class="id">com</span> :=<br/>
&nbsp;&nbsp;<span class="id">LET</span> (<span class="id">ALLOC</span> 2) (<span class="kwd">fun</span> <span class="id">a</span>' =&gt; <span class="id">SEQ</span> (<span class="id">SET</span> <span class="id">a</span>' <span class="id">n</span>) (<span class="id">SEQ</span> (<span class="id">SET</span> (<span class="id">a</span>' + 1) <span class="id">a</span>) (<span class="id">PURE</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">a</a></span>'))).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_cons_correct</span>: <span class="kwd">forall</span> <span class="id">a</span> <span class="id">n</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_cons</span> <span class="id">n</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">a</span>' =&gt; <span class="id">list_at</span> <span class="id">a</span>' (<span class="id">n</span> :: <span class="id">l</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof136')">Proof.</div>
<div class="proofscript" id="proof136">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">triple_let</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">sepconj_emp</span> <span class="tactic">at</span> 1. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_alloc</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">b</span>; <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>, ! <span class="id">sepconj_assoc</span>, <span class="id">sepconj_emp</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_set</span>. <span class="tactic">simpl</span>; <span class="tactic">intros</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_set</span>. <span class="tactic">simpl</span>; <span class="tactic">intros</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_pure</span>. <span class="tactic">intros</span> <span class="id">h</span> <span class="id">A</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">a</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Computing the length of a list </h2>
<br/>
<div class="doc">Taking advantage of the coinductive nature of type <span class="bracket"><span class="id">com</span></span>,
    we use infinite commands to represent loops and tail-recursive functions. </div>
<br/>
<span class="kwd">CoFixpoint</span> <span class="id">list_length_rec</span> (<span class="id">a</span>: <span class="id">addr</span>) (<span class="id">len</span>: <span class="id">Z</span>) : <span class="id">com</span> :=<br/>
&nbsp;&nbsp;<span class="id">IFTHENELSE</span> <span class="id">a</span> (<span class="id">LET</span> (<span class="id">GET</span> (<span class="id">a</span> + 1)) (<span class="kwd">fun</span> <span class="id">t</span> =&gt; <span class="id">list_length_rec</span> <span class="id">t</span> (<span class="id">len</span> + 1))) (<span class="id">PURE</span> <span class="id">len</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">list_length</span> (<span class="id">a</span>: <span class="id">addr</span>) : <span class="id">com</span> := <span class="id">list_length_rec</span> <span class="id">a</span> 0.<br/>
<br/>
<div class="doc">Normally we would write
<pre>
   len = 0;
   while (a != 0) { a = get (a + 1); len = len + 1; }</pre>
   With the coinductive definition, we write the equivalent infinite command
<pre>
   if (a == 0) return 0; else {
     a1 = get (a + 1);
     if (a1 == 0) return 1; else {
       a2 = get (a1 + 1);
       if (a2 == 0) return 2; else ...</pre>
</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_length_rec_correct</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">a</span> <span class="id">len</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_length_rec</span> <span class="id">a</span> <span class="id">len</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">len</span>' =&gt; (<span class="id">len</span>' = <span class="id">len</span> + <span class="id">Z.of_nat</span> (<span class="id">List.length</span> <span class="id">l</span>)) //\\ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof137')">Proof.</div>
<div class="proofscript" id="proof137">
<span class="kwd">Local</span> <span class="id">Opaque</span> <span class="id">Z.of_nat</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span> <span class="kwd">as</span> [ | <span class="id">h</span> <span class="id">t</span>]; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> (<span class="id">unroll_com</span> (<span class="id">list_length_rec</span> <span class="id">a</span> <span class="id">len</span>)); <span class="id">cbn</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intro</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_ifelse</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_pure</span>. <span class="tactic">intros</span> <span class="id">h</span> <span class="id">H2</span>. <span class="tactic">split</span>. <span class="id">lia</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intro</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_lift_exists</span>; <span class="tactic">intros</span> <span class="id">a</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_ifthen</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_get</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">a</span>''. <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span> <span class="id">H3</span>. <span class="tactic">subst</span> <span class="id">a</span>''.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_swap3</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_post</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">IHt</span>. <span class="tactic">intros</span> <span class="id">len</span>'; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">rewrite</span> &lt;- <span class="id">sepconj_swap3</span>, <span class="id">sepconj_pick2</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h1</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="tactic">split</span>. <span class="id">lia</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">a</span>'; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Corollary</span> <span class="id">list_length_correct</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_length</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">len</span> =&gt; (<span class="id">len</span> = <span class="id">Z.of_nat</span> (<span class="id">length</span> <span class="id">l</span>)) //\\ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof138')">Proof.</div>
<div class="proofscript" id="proof138">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">list_length_rec_correct</span>.<br/>
Qed.</div>
<br/>
<h2> Concatenating two lists in-place </h2>
<br/>
<div class="doc">In loop notation:
<pre>
  if (l1 == 0) return l2; else {
    t = get(l1 + 1);
    while (get (t + 1) != 0) t = get (t + 1);
    set (t + 1, l2);
    return l1;
  }</pre>
</div>
<br/>
<span class="kwd">CoFixpoint</span> <span class="id">list_concat_rec</span> (<span class="id">a1</span> <span class="id">a2</span>: <span class="id">addr</span>) : <span class="id">com</span> :=<br/>
&nbsp;&nbsp;<span class="id">LET</span> (<span class="id">GET</span> (<span class="id">a1</span> + 1)) (<span class="kwd">fun</span> <span class="id">t</span> =&gt; <span class="id">IFTHENELSE</span> <span class="id">t</span> (<span class="id">list_concat_rec</span> <span class="id">t</span> <span class="id">a2</span>) (<span class="id">SET</span> (<span class="id">a1</span> + 1) <span class="id">a2</span>)).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">list_concat</span> (<span class="id">a1</span> <span class="id">a2</span>: <span class="id">addr</span>) : <span class="id">com</span> :=<br/>
&nbsp;&nbsp;<span class="id">IFTHENELSE</span> <span class="id">a1</span> (<span class="id">SEQ</span> (<span class="id">list_concat_rec</span> <span class="id">a1</span> <span class="id">a2</span>) (<span class="id">PURE</span> <span class="id">a1</span>)) (<span class="id">PURE</span> <span class="id">a2</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_concat_rec_correct</span>: <span class="kwd">forall</span> <span class="id">l2</span> <span class="id">a2</span> <span class="id">l1</span> <span class="id">a1</span>,<br/>
&nbsp;&nbsp;<span class="id">a1</span> &lt;&gt; 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id"><a href="CDF.Seplog.html#com">list_at</a></span> <span class="id">a1</span> <span class="id">l1</span> ** <span class="id">list_at</span> <span class="id">a2</span> <span class="id">l2</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_concat_rec</span> <span class="id">a1</span> <span class="id">a2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">list_at</span> <span class="id">a1</span> (<span class="id">l1</span> ++ <span class="id">l2</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof139')">Proof.</div>
<div class="proofscript" id="proof139">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l1</span> <span class="kwd">as</span> [ | <span class="id">h1</span> <span class="id">t1</span>]; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> (<span class="id">unroll_com</span> (<span class="id">list_concat_rec</span> <span class="id">a1</span> <span class="id">a2</span>)); <span class="tactic">simpl</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span>. <span class="id">lia</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_aexists</span>. <span class="tactic">apply</span> <span class="id">triple_lift_exists</span>. <span class="tactic">intros</span> <span class="id">a</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_assoc</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">rewrite</span> <span class="id">sepconj_assoc</span>, <span class="id">sepconj_pick2</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_get</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">intros</span> <span class="id">t</span>. <span class="tactic">simpl</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span> <span class="id">H2</span>; <span class="tactic">subst</span> <span class="id">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_ifthenelse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">sepconj_assoc</span>, <span class="id">sepconj_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_post</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">IHt1</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">intros</span> <span class="id">_</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>, <span class="id">sepconj_swap3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> <span class="id">P</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id"><a href="CDF.Seplog.html#triple_ifthenelse">a</a></span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_post</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_frame</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_pre</span>. <span class="tactic">apply</span> <span class="id">triple_set</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> <span class="id">P</span>; <span class="id">exists</span> <span class="id">a</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">intros</span> <span class="id">_</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>, <span class="id">sepconj_pick3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">t1</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;** <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>, <span class="id">sepconj_emp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">a2</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;** <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">intros</span> <span class="id">h</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="id">lia</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_concat_correct</span>: <span class="kwd">forall</span> <span class="id">l1</span> <span class="id">a1</span> <span class="id">l2</span> <span class="id">a2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a1</span> <span class="id">l1</span> ** <span class="id">list_at</span> <span class="id">a2</span> <span class="id">l2</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_concat</span> <span class="id">a1</span> <span class="id">a2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">a</span> =&gt; <span class="id">list_at</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">a</a></span> (<span class="id">l1</span> ++ <span class="id">l2</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof140')">Proof.</div>
<div class="proofscript" id="proof140">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">list_concat</span>. <span class="tactic">apply</span> <span class="id">triple_ifthenelse</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span> <span class="id">H1</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>. <span class="tactic">apply</span> <span class="id">list_concat_rec_correct</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">intros</span> <span class="id">_</span>. <span class="tactic">apply</span> <span class="id"><a href="CDF.Seplog.html#list_at">triple_pure</a></span>. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id"><a href="CDF.Seplog.html#list_at">l1</a></span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">triple_pure</span>. <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>, <span class="id">sepconj_emp</span>. <span class="tactic">intros</span> <span class="id">h</span> (<span class="id">A</span> &amp; <span class="id">B</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span>; <span class="id"><a href="CDF.Seplog.html#list_concat_rec_correct">lia</a></span>.<br/>
Qed.</div>
<br/>
<h2> List reversal in place </h2>
<br/>
<div class="doc">In loop notation:
<pre>
  p = 0;
  while (l != 0) {
    n = get (l + 1);
    set (l + 1, p);
    p = l;
    l = n;
  }
  return p;</pre>
</div>
<br/>
<span class="kwd">CoFixpoint</span> <span class="id">list_rev_rec</span> (<span class="id">a</span> <span class="id">p</span>: <span class="id">addr</span>) : <span class="id">com</span> :=<br/>
&nbsp;&nbsp;<span class="id">IFTHENELSE</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">LET</span> (<span class="id">GET</span> (<span class="id">a</span> + 1)) (<span class="kwd">fun</span> <span class="id">n</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">SEQ</span> (<span class="id">SET</span> (<span class="id">a</span> + 1) <span class="id">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">list_rev_rec</span> <span class="id">n</span> <span class="id">a</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PURE</span> <span class="id">p</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">list_rev</span> (<span class="id">a</span>: <span class="id">addr</span>) : <span class="id">com</span> := <span class="id">list_rev_rec</span> <span class="id">a</span> 0.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_rev_rec_correct</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">a</span> <span class="id">l</span>' <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ** <span class="id">list_at</span> <span class="id">p</span> <span class="id">l</span>' ⦄<br/>
&nbsp;&nbsp;<span class="id">list_rev_rec</span> <span class="id">a</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">list_at</span> <span class="id">x</span> (<span class="id">List.rev_append</span> <span class="id">l</span> <span class="id">l</span>') ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof141')">Proof.</div>
<div class="proofscript" id="proof141">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span> <span class="kwd">as</span> [ | <span class="id">hd</span> <span class="id">l</span>]; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> (<span class="id">unroll_com</span> (<span class="id">list_rev_rec</span> <span class="id">a</span> <span class="id">p</span>)); <span class="tactic">simpl</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>, <span class="id">sepconj_emp</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>; <span class="tactic">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_ifelse</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">triple_pure</span>. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>; <span class="tactic">apply</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#rev_append">triple_lift_pure</a></span>; <span class="tactic">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_aexists</span>; <span class="tactic">apply</span> <span class="id">triple_lift_exists</span>; <span class="tactic">intros</span> <span class="id">a</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_ifthen</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">triple_let</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> ! <span class="id">sepconj_assoc</span>, <span class="id">sepconj_pick2</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">triple_get</span>. <span class="tactic">intros</span> <span class="id">a</span>''. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>. <span class="tactic">apply</span> <span class="id">triple_lift_pure</span>. <span class="tactic">intros</span> <span class="id">H3</span>. <span class="tactic">subst</span> <span class="id">a</span>''.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_let</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">eapply</span> <span class="id">triple_consequence_pre</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">triple_set</span>. <br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> <span class="id">P</span>; <span class="id">exists</span> <span class="id">a</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">intros</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_pick2</span>, <span class="id">sepconj_pick3</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_pre</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">sepconj_imp_r</span>. <span class="tactic">intros</span> <span class="id">h</span> <span class="id">A</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">p</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_rev_correct</span>: <span class="kwd">forall</span> <span class="id">a</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="id">list_at</span> <span class="id">a</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">list_rev</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">list_at</span> <span class="id">x</span> (<span class="id">List.rev</span> <span class="id">l</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof142')">Proof.</div>
<div class="proofscript" id="proof142">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_pick3">List.rev_alt</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">triple_consequence_pre</span>. <span class="tactic">apply</span> <span class="id">list_rev_rec_correct</span>. <br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_comm</span>, <span class="id">lift_pureconj</span>, <span class="id">sepconj_emp</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id"><a name="list_rev_correct">h</a></span> <span class="id">A</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h1> 4. An alternate definition of separation logic triples </h1>
<br/>
<span class="kwd">Module</span> <span class="id">AlternateSeplog</span>.<br/>
<br/>
<div class="doc">For some languages, the frame property for reductions (lemma
    <span class="bracket"><span class="id">red_frame</span></span> above) does not hold, e.g. because allocations are
    deterministic.  Or maybe we do not want to prove the <span class="bracket"><span class="id">red_frame</span></span>
    lemma.
    In this case, not all is lost: we can define our separation
    triples <span class="bracket"> ⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ </span> as Hoare triples plus framing. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">Hoare</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">Q</span>: <span class="id">postcond</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h</span>, <span class="id">P</span> <span class="id"><a name="triple_frame_consequence">h</a></span> -&gt; <span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">triple</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">Q</span>: <span class="id">postcond</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">R</span>: <span class="id">assertion</span>), <span class="id">Hoare</span> (<span class="id">P</span> ** <span class="id">R</span>) <span class="id">c</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>).<br/>
<br/>
<span class="kwd">Notation</span> "⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄" := (<span class="id">triple</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>) (<span class="tactic">at</span> <span class="id">level</span> 90, <span class="id">c</span> <span class="tactic">at</span> <span class="id">next</span> <span class="id">level</span>).<br/>
<br/>
<div class="doc">This definition validates the frame rule. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_frame</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ** <span class="id">R</span> ⦄ <span class="id">c</span> ⦃ <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof143')">Proof.</div>
<div class="proofscript" id="proof143">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">R</span> <span class="id">TR</span> <span class="id">R</span>'. <span class="tactic">rewrite</span> <span class="id">sepconj_assoc</span>.<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; (<span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>) ** <span class="id">R</span>') <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** (<span class="id">R</span> ** <span class="id">R</span>')).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">functional_extensionality</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_assoc</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">It also validates the "small rules" for heap operations. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_get</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ⦄ <span class="id">GET</span> <span class="id">l</span> ⦃ <span class="kwd">fun</span> <span class="id">v</span>' =&gt; (<span class="id">v</span>' = <span class="id">v</span>) //\\ <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof144')">Proof.</div>
<div class="proofscript" id="proof144">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">v</span> <span class="id">R</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">H1</span> &amp; <span class="id">H2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L1</span>: <span class="id">h1</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">subst</span> <span class="id">h1</span>. <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">U</span>; <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">L1</span>; <span class="tactic">auto</span>. } <br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">constructor</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>. <span class="id"><a name="wp">inv</a></span> <span class="id">RED</span>. <span class="id">constructor</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">h1</span>, <span class="id">h2</span>. <span class="tactic">unfold</span> <span class="id">pureconj</span>. <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_set</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">valid</span> <span class="id">l</span> ⦄ <span class="id">SET</span> <span class="id">l</span> <span class="id">v</span> ⦃ <span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">contains</span> <span class="id"><a name="wp_precond">l</a></span> <span class="id">v</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof145')">Proof.</div>
<div class="proofscript" id="proof145">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">v</span> <span class="id">R</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">H1</span> &amp; <span class="id">H2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> (<span class="id">v0</span> &amp; <span class="id">H1</span>). <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L1</span>: <span class="id">h1</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">subst</span> <span class="id">h1</span>; <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">rewrite</span> <span class="id">U</span>; <span class="id">cbn</span>. <span class="tactic">rewrite</span> <span class="id">L1</span>; <span class="tactic">auto</span>. } <br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">constructor</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>. <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">hupdate</span> <span class="id">l</span> <span class="id">v</span> <span class="id">hempty</span>), <span class="id">h2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">red</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">intro</span> <span class="id">l</span>'. <span class="id">specialize</span> (<span class="id">D</span> <span class="id">l</span>'). <span class="id">cbn</span> <span class="kwd">in</span> *. <span class="tactic">destruct</span> <span class="id">D</span>; <span class="tactic">auto</span>. <span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">l</span>'); <span class="tactic">auto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">l</span>'; <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">l</span>'); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">valid_N_init</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">R</span>: <span class="id">assertion</span>) <span class="id">sz</span> <span class="id">l</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id">R</span> <span class="id"><a href="CDF.Seplog.html#wp_precond">h</a></span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">i</span>, <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id">Z.of_nat</span> <span class="id">sz</span> -&gt; <span class="id">h</span> <span class="id">i</span> = <span class="id">None</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id">valid_N</span> <span class="id">l</span> <span class="id">sz</span> ** <span class="id">R</span>) (<span class="id">hinit</span> <span class="id">l</span> <span class="id">sz</span> <span class="id">h</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof146')">Proof.</div>
<div class="proofscript" id="proof146">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">sz</span> <span class="kwd">as</span> [ | <span class="id">sz</span>]; <span class="tactic">intros</span> <span class="id">l</span> <span class="id">h</span> <span class="id">Rh</span> <span class="id"><a href="CDF.Seplog.html#com">EMPTY</a></span>; <span class="id">cbn</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">sepconj_emp</span>. <span class="tactic">auto</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id">sepconj_assoc</span>. <span class="id">exists</span> (<span class="id">hupdate</span> <span class="id">l</span> 0 <span class="id">hempty</span>), (<span class="id">hinit</span> (<span class="id">l</span> + 1) <span class="id">sz</span> <span class="id">h</span>).<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">exists</span> 0. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">IHsz</span>. <span class="tactic">auto</span>. <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">EMPTY</span>. <span class="id">lia</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">intros</span> <span class="id">x</span>. <span class="tactic">unfold</span> <span class="id">hupdate</span>, <span class="id">hempty</span>; <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="tactic">rewrite</span> <span class="id">hinit_outside</span> <span class="tactic">by</span> <span class="id">lia</span>. <span class="tactic">apply</span> <span class="id">EMPTY</span>; <span class="id">lia</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">x</span>. <span class="id">cbn</span>. <span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_alloc</span>: <span class="kwd">forall</span> <span class="id">sz</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">emp</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">ALLOC</span> <span class="id">sz</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">l</span> =&gt; (<span class="id">l</span> &lt;&gt; 0) //\\ <span class="id">valid_N</span> <span class="id"><a name="wp_consequence">l</a></span> <span class="id">sz</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof147')">Proof.</div>
<div class="proofscript" id="proof147">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">sz</span> <span class="id">R</span> <span class="id">h</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_emp</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">destruct</span> (<span class="id">isfinite</span> <span class="id">h</span>) <span class="kwd">as</span> (<span class="id">l0</span> &amp; <span class="id">FIN</span>). <span class="tactic">apply</span> <span class="id">immsafe_alloc</span> <span class="kwd">with</span> (<span class="id">Z.max</span> <span class="id">l0</span> 1); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;+ <span class="id">lia</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">FIN</span>. <span class="id">lia</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_pureconj</span>; <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">valid_N_init</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_free</span>: <span class="kwd">forall</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">valid</span> <span class="id">l</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">FREE</span> <span class="id">l</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">emp</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof148')">Proof.</div>
<div class="proofscript" id="proof148">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">l</span> <span class="id">R</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">H1</span> &amp; <span class="id">H2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> (<span class="id">v0</span> &amp; <span class="id">H1</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L1</span>: <span class="id">h1</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">apply</span> <span class="id">hupdate_same</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id">Some</span> <span class="id"><a href="CDF.Seplog.html#wp_frame">v0</a></span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">rewrite</span> <span class="id">U</span>; <span class="id">cbn</span>. <span class="tactic">rewrite</span> <span class="id">L1</span>. <span class="tactic">auto</span>. } <br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>. <span class="tactic">congruence</span>. <br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>. <span class="tactic">rewrite</span> <span class="id"><a href="CDF.Seplog.html#wp_frame_consequence">sepconj_emp</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id">hfree</span> <span class="id">l</span> (<span class="id">hunion</span> <span class="id">h1</span> <span class="id">h2</span>)) <span class="kwd">with</span> <span class="id">h2</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">heap_extensionality</span>; <span class="tactic">intros</span> <span class="id">x</span>. <span class="tactic">generalize</span> (<span class="id">D</span> <span class="id">x</span>); <span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Z.eq_dec</span> <span class="id">l</span> <span class="id">x</span>); <span class="tactic">auto</span>. <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc">The rules for control structures are also valid.  
    Proof plan: first show Hoare-style rules for the <span class="bracket"><span class="id">Hoare</span></span> triple,
    then frame by an arbitrary <span class="bracket"><span class="id">R</span></span> to obtain the separation triple. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">Hoare_pure</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">v</span> (<span class="id">Q</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> (<span class="id"><a href="CDF.Seplog.html#wp_precond">PURE</a></span> <span class="id">v</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof149')">Proof.</div>
<div class="proofscript" id="proof149">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">intros</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id">H</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_pure</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id"><a href="CDF.Seplog.html#wp">v</a></span> (<span class="id">Q</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">PURE</span> <span class="id">v</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof150')">Proof.</div>
<div class="proofscript" id="proof150">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">intros</span> <span class="id">R</span>. <span class="tactic">apply</span> <span class="id">Hoare_pure</span>. <span class="tactic">apply</span> <span class="id">sepconj_imp_l</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">Hoare_let</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id"><a href="CDF.Seplog.html#wp_precond">c</a></span> <span class="id">f</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">Q</span> <span class="id">R</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Hoare</span> (<span class="id">Q</span> <span class="id">v</span>) (<span class="id">f</span> <span class="id">v</span>) <span class="id">R</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> (<span class="id">LET</span> <span class="id">c</span> <span class="id">f</span>) <span class="id">R</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof151')">Proof.</div>
<div class="proofscript" id="proof151">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">R</span>; <span class="tactic">intros</span> <span class="id">HR1</span> <span class="id">HR2</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">safe_let</span> <span class="kwd">with</span> <span class="id">Q</span>. <span class="tactic">apply</span> <span class="id">HR2</span>. <span class="tactic">apply</span> <span class="id">HR1</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_let</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> (<span class="id">P</span>: <span class="id">precond</span>) (<span class="id">Q</span> <span class="id">R</span>: <span class="id">postcond</span>),<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, ⦃ <span class="id">Q</span> <span class="id">v</span> ⦄ <span class="id">f</span> <span class="id">v</span> ⦃ <span class="id">R</span> ⦄) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">LET</span> <span class="id">c</span> <span class="id">f</span> ⦃ <span class="id">R</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof152')">Proof.</div>
<div class="proofscript" id="proof152">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">c</span> <span class="id">f</span> <span class="id">P</span> <span class="id">Q</span> <span class="id">R</span> <span class="id">TR1</span> <span class="id">TR2</span> <span class="id">R</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="CDF.Separation.html#emp">Hoare_let</a></span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>').<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">TR1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">TR2</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">Hoare_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id"><a href="CDF.Separation.html#contains">P</a></span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> ((<span class="id">b</span> &lt;&gt; 0) //\\ <span class="id">P</span>) <span class="id">c1</span> <span class="id">Q</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> ((<span class="id">b</span> = 0) //\\ <span class="id">P</span>) <span class="id">c2</span> <span class="id">Q</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> (<span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof153')">Proof.</div>
<div class="proofscript" id="proof153">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">Q</span>; <span class="tactic">intros</span> <span class="id">HR1</span> <span class="id"><a href="CDF.Separation.html#contains">HR2</a></span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="tactic">destruct</span> (<span class="id">Z.eqb_spec</span> <span class="id">b</span> 0).<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">HR2</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">HR1</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ (<span class="id">b</span> &lt;&gt; 0) //\\ <span class="id">P</span> ⦄ <span class="id">c1</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ (<span class="id">b</span> = 0) //\\ <span class="id">P</span> ⦄ <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof154')">Proof.</div>
<div class="proofscript" id="proof154">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span> <span class="id">TR1</span> <span class="id">TR2</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="CDF.Separation.html#valid">Hoare_ifthenelse</a></span>; <span class="tactic">rewrite</span> &lt;- <span class="id">lift_pureconj</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a href="CDF.Seplog.html#wp_weakest">Hoare_consequence</a></span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>' <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">P</span>' -&gt; (<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span>' <span class="id">v</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof155')">Proof.</div>
<div class="proofscript" id="proof155">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">safe_consequence</span> <span class="kwd">with</span> <span class="id">Q</span>'; <span class="tactic">auto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_consequence</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">P</span>' <span class="id">c</span> <span class="id">Q</span>' <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span>' ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">P</span>' -&gt; (<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span>' <span class="id">v</span> --&gt;&gt; <span class="id">Q</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof156')">Proof.</div>
<div class="proofscript" id="proof156">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">Hoare_consequence</span> <span class="kwd">with</span> (<span class="id">P</span>' ** <span class="id">R</span>) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span>' <span class="id">v</span> ** <span class="id">R</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">sepconj_imp_l</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">apply</span> <span class="id">sepconj_imp_l</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">Hoare_pick</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;<span class="id">Hoare</span> <span class="id">P</span> (<span class="id">PICK</span> <span class="id">n</span>) (<span class="kwd">fun</span> <span class="id">i</span> =&gt; (0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span>) //\\ <span class="id">P</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof157')">Proof.</div>
<div class="proofscript" id="proof157">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">P</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="tactic">intros</span> <span class="id">c</span>' <span class="id">h</span>' <span class="id">RED</span>; <span class="id">inv</span> <span class="id">RED</span>. <span class="id">constructor</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_pick</span>: <span class="kwd">forall</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">emp</span> ⦄<br/>
&nbsp;&nbsp;<span class="id">PICK</span> <span class="id">n</span><br/>
&nbsp;&nbsp;⦃ <span class="kwd">fun</span> <span class="id">i</span> =&gt; <span class="id">pure</span> (0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span>) ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof158')">Proof.</div>
<div class="proofscript" id="proof158">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">intros</span> <span class="id">R</span>. <span class="tactic">rewrite</span> <span class="id">sepconj_emp</span>. <span class="tactic">eapply</span> <span class="id">Hoare_consequence</span> <span class="kwd">with</span> (<span class="id">P</span>' := <span class="id">R</span>). <span class="tactic">apply</span> <span class="id">Hoare_pick</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">pureconj_sepconj</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">AlternateSeplog</span>.<br/>
<br/>
<h1> 5. Ramification </h1>
<br/>
<div class="doc">Assume we have a triple <span class="bracket">{<span class="id">P</span>'} <span class="id">c</span> {<span class="id"><a href="CDF.Seplog.html#PICK">Q</a></span>'}</span> and we want to conclude <span class="bracket">{<span class="id">P</span>} <span class="id">c</span> {<span class="id">Q</span>}</span>.
    In general, we need to frame the former triple by an appropriate <span class="bracket"><span class="id">R</span></span>,
    then use the consequence rule to conclude. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_frame_consequence</span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">P</span>' <span class="id">Q</span>',<br/>
&nbsp;&nbsp;⦃ <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">P</a></span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span>' --&gt;&gt; <span class="id">P</span> ** <span class="id">R</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> --&gt;&gt; <span class="id">Q</span>' <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span>' ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof159')">Proof.</div>
<div class="proofscript" id="proof159">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">triple_consequence</span> <span class="kwd">with</span> (<span class="id">P</span> ** <span class="id">R</span>) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>); <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">This rule still needs the user to guess the framing predicate <span class="bracket"><span class="id">R</span></span>.
    An alternate presentation uses the magic wand instead.
    This approach is called "ramification" in the literature. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">triple_ramification</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">P</span>' <span class="id">Q</span>',<br/>
&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span>' --&gt;&gt; <span class="id">P</span> ** (<span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> --* <span class="id">Q</span>' <span class="id">v</span>)) -&gt;<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span>' ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span>' ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof160')">Proof.</div>
<div class="proofscript" id="proof160">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">triple_frame_consequence</span> <span class="kwd">with</span> (<span class="id">R</span> := <span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> --* <span class="id">Q</span>' <span class="id">v</span>)).<br/>
&nbsp;&nbsp;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">Q1</span> &amp; <span class="id">W2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> (<span class="id">wand_cancel</span> (<span class="id">Q</span> <span class="id">v</span>)). <span class="id">exists</span> <span class="id">h1</span>, <span class="id">h2</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h1> 6. Weakest preconditions </h1>
<br/>
<h2> 6.1.  Definition and characterization </h2>
<br/>
<div class="doc">Here is one possible definition of the weakest precondition for
    command <span class="bracket"><span class="id">c</span></span> with postcondition <span class="bracket"><span class="id">Q</span></span>. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">wp</span> (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">Q</span>: <span class="id">postcond</span>) : <span class="id">precond</span> :=<br/>
&nbsp;&nbsp;<span class="id">aexists</span> (<span class="kwd">fun</span> <span class="id">P</span> =&gt; ⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ //\\ <span class="id">P</span>).<br/>
<br/>
<div class="doc">What matters about <span class="bracket"><span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span></span> is that it is a precondition... </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_precond</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof161')">Proof.</div>
<div class="proofscript" id="proof161">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">h</span> (<span class="id">P</span> &amp; <span class="id">T</span> &amp; <span class="id">C</span>). <span class="tactic">apply</span> <span class="id">T</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">... and it is implied by any other precondition. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_weakest</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof162')">Proof.</div>
<div class="proofscript" id="proof162">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">T</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">exists</span> <span class="id">P</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">This leads to the following alternate definition of triples in terms
    of weakest preconditions. </div>
<br/>
<span class="kwd">Corollary</span> <span class="id">wp_equiv</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ &lt;-&gt; (<span class="id">P</span> --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof163')">Proof.</div>
<div class="proofscript" id="proof163">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
- <span class="tactic">apply</span> <span class="id">wp_weakest</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_consequence_pre</span> <span class="kwd">with</span> (<span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>); <span class="tactic">auto</span> <span class="kwd">using</span> <span class="id">wp_precond</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Here is another definition of the weakest precondition, using the
    operational semantics directly. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">wp</span>' (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">Q</span>: <span class="id">postcond</span>) : <span class="id">precond</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">fun</span> <span class="id">h</span> =&gt; <span class="id">safe</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp</span>'<span class="id">_precond</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">wp</span>' <span class="id">c</span> <span class="id">Q</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof164')">Proof.</div>
<div class="proofscript" id="proof164">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">h</span> <span class="id">SAFE</span>. <span class="tactic">apply</span> <span class="id">SAFE</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp</span>'<span class="id">_weakest</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;⦃ <span class="id">P</span> ⦄ <span class="id">c</span> ⦃ <span class="id">Q</span> ⦄ -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> --&gt;&gt; <span class="id">wp</span>' <span class="id">c</span> <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof165')">Proof.</div>
<div class="proofscript" id="proof165">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">intros</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="tactic">apply</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 6.2. Structural rules for weakest preconditions </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_consequence</span>: <span class="kwd">forall</span> (<span class="id">Q</span> <span class="id">Q</span>': <span class="id">postcond</span>) <span class="id">c</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span> <span class="id">v</span> --&gt;&gt; <span class="id">Q</span>' <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span> --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof166')">Proof.</div>
<div class="proofscript" id="proof166">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_consequence_post</span> <span class="kwd">with</span> <span class="id">Q</span>; <span class="tactic">auto</span> <span class="kwd">using</span> <span class="id">wp_precond</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_frame</span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span> ** <span class="id">R</span> --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof167')">Proof.</div>
<div class="proofscript" id="proof167">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_frame</span>. <span class="tactic">apply</span> <span class="id">wp_precond</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Corollary</span> <span class="id">wp_frame_consequence</span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">Q</span> <span class="id">c</span> <span class="id">Q</span>',<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> --&gt;&gt; <span class="id">Q</span>' <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span> ** <span class="id">R</span> --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof168')">Proof.</div>
<div class="proofscript" id="proof168">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_consequence</span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>). <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">wp_frame</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Corollary</span> <span class="id">wp_ramification</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">Q</span>',<br/>
&nbsp;&nbsp;<span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span> ** <span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> --* <span class="id">Q</span>' <span class="id">v</span>) --&gt;&gt; <span class="id">wp</span> <span class="id">c</span> <span class="id">Q</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof169')">Proof.</div>
<div class="proofscript" id="proof169">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_frame_consequence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>). <span class="tactic">apply</span> (<span class="id">wand_cancel</span> (<span class="id">Q</span> <span class="id">v</span>)). <span class="id">exists</span> <span class="id">h1</span>, <span class="id">h2</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> 6.3.  Weakest precondition rules for our language of pointers </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_pure</span>: <span class="kwd">forall</span> (<span class="id">Q</span>: <span class="id">postcond</span>) <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">Q</span> <span class="id">v</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">PURE</span> <span class="id">v</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof170')">Proof.</div>
<div class="proofscript" id="proof170">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_pure</span>. <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_let</span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">wp</span> <span class="id">c</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">wp</span> (<span class="id">f</span> <span class="id">v</span>) <span class="id">Q</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">LET</span> <span class="id">c</span> <span class="id">f</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof171')">Proof.</div>
<div class="proofscript" id="proof171">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">eapply</span> <span class="id">triple_let</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">wp_precond</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_precond</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_ifthenelse</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">if</span> <span class="id">b</span> =? 0 <span class="kwd">then</span> <span class="id">wp</span> <span class="id">c2</span> <span class="id">Q</span> <span class="kwd">else</span> <span class="id">wp</span> <span class="id">c1</span> <span class="id">Q</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">IFTHENELSE</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof172')">Proof.</div>
<div class="proofscript" id="proof172">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_ifthenelse</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_consequence_pre</span> <span class="kwd">with</span> (<span class="id">wp</span> <span class="id">c1</span> <span class="id">Q</span>). <span class="tactic">apply</span> <span class="id">wp_precond</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="tactic">rewrite</span> &lt;- <span class="id">Z.eqb_neq</span> <span class="kwd">in</span> <span class="id">A</span>. <span class="tactic">rewrite</span> <span class="id">A</span> <span class="kwd">in</span> <span class="id">B</span>. <span class="tactic">auto</span>.<br/>
- <span class="tactic">apply</span> <span class="id">triple_consequence_pre</span> <span class="kwd">with</span> (<span class="id">wp</span> <span class="id">c2</span> <span class="id">Q</span>). <span class="tactic">apply</span> <span class="id">wp_precond</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="tactic">subst</span> <span class="id">b</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_alloc</span>: <span class="kwd">forall</span> <span class="id">sz</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">l</span> =&gt; (<span class="id">l</span> &lt;&gt; 0) //\\ <span class="id">valid_N</span> <span class="id">l</span> <span class="id">sz</span> --* <span class="id">Q</span> <span class="id">l</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">ALLOC</span> <span class="id">sz</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof173')">Proof.</div>
<div class="proofscript" id="proof173">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">wp_ramification</span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="kwd">fun</span> <span class="id">l</span> =&gt; (<span class="id">l</span> &lt;&gt; 0) //\\ <span class="id">valid_N</span> <span class="id">l</span> <span class="id">sz</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">sepconj_imp_l</span> <span class="kwd">with</span> <span class="id">emp</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_alloc</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">sepconj_emp</span>. <span class="tactic">assumption</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_get</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> ** (<span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> --* <span class="id">Q</span> <span class="id">v</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">GET</span> <span class="id">l</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof174')">Proof.</div>
<div class="proofscript" id="proof174">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">W</span>: <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">GET</span> <span class="id">l</span>) (<span class="kwd">fun</span> <span class="id">v</span>' =&gt; (<span class="id">v</span>' = <span class="id">v</span>) //\\ <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_get</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">wp_ramification</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_l</span>. <span class="id">eexact</span> <span class="id">W</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>. 2: <span class="id">eexact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span>' <span class="id">H</span>' <span class="id">v</span>' <span class="id">h</span>'' <span class="id">D</span> (<span class="id">A</span> &amp; <span class="id">B</span>). <span class="tactic">subst</span> <span class="id">v</span>'. <span class="tactic">apply</span> <span class="id">H</span>'; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_set</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">valid</span> <span class="id">l</span> ** <span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">v</span>' =&gt; (<span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> --* <span class="id">Q</span> <span class="id">v</span>')) --&gt;&gt; <span class="id">wp</span> (<span class="id">SET</span> <span class="id">l</span> <span class="id">v</span>) <span class="id">Q</span>. <br/>
<div class="toggleproof" onclick="toggleDisplay('proof175')">Proof.</div>
<div class="proofscript" id="proof175">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">W</span>: <span class="id">valid</span> <span class="id">l</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">SET</span> <span class="id">l</span> <span class="id">v</span>) (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">contains</span> <span class="id">l</span> <span class="id">v</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_set</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">wp_ramification</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_l</span>. <span class="id">eexact</span> <span class="id">W</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>. 2: <span class="id">eexact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Corollary</span> <span class="id">wp_set</span>': <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">valid</span> <span class="id">l</span> ** (<span class="id">contains</span> <span class="id">l</span> <span class="id">v</span> --* <span class="id">Q</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">SET</span> <span class="id">l</span> <span class="id">v</span>) (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">Q</span>). <br/>
<div class="toggleproof" onclick="toggleDisplay('proof176')">Proof.</div>
<div class="proofscript" id="proof176">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_set</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span>' <span class="id">H</span>' <span class="id">v</span>'. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_free</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">valid</span> <span class="id">l</span> ** <span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">v</span>' =&gt; <span class="id">Q</span> <span class="id">v</span>') --&gt;&gt; <span class="id">wp</span> (<span class="id">FREE</span> <span class="id">l</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof177')">Proof.</div>
<div class="proofscript" id="proof177">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">W</span>: <span class="id">valid</span> <span class="id">l</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">FREE</span> <span class="id">l</span>) (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">emp</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_free</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">wp_ramification</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_l</span>. <span class="id">eexact</span> <span class="id">W</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>. 2: <span class="id">eexact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">intros</span> <span class="id">v</span> <span class="id">h</span>' <span class="id">D</span> <span class="id">E</span>. <span class="tactic">rewrite</span> <span class="id">E</span> <span class="kwd">in</span> *. <span class="tactic">rewrite</span> <span class="id">hunion_comm</span>, <span class="id">hunion_empty</span> <span class="tactic">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Corollary</span> <span class="id">wp_free</span>': <span class="kwd">forall</span> <span class="id">l</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">valid</span> <span class="id">l</span> ** <span class="id">Q</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">FREE</span> <span class="id">l</span>) (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">Q</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof178')">Proof.</div>
<div class="proofscript" id="proof178">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">wp_free</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">h</span>' <span class="id">H</span>' <span class="id">v</span>'. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wp_pick</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">aforall</span> (<span class="kwd">fun</span> <span class="id">i</span> =&gt; <span class="id">pure</span> (0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span>) --* <span class="id">Q</span> <span class="id">i</span>) --&gt;&gt; <span class="id">wp</span> (<span class="id">PICK</span> <span class="id">n</span>) <span class="id">Q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof179')">Proof.</div>
<div class="proofscript" id="proof179">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">W</span>: <span class="id">emp</span> --&gt;&gt; <span class="id">wp</span> (<span class="id">PICK</span> <span class="id">n</span>) (<span class="kwd">fun</span> <span class="id">i</span> =&gt; <span class="id">pure</span> (0 &lt;= <span class="id">i</span> &lt; <span class="id">n</span>))).<br/>
&nbsp;&nbsp;{ <span class="tactic">apply</span> <span class="id">wp_weakest</span>. <span class="tactic">apply</span> <span class="id">triple_pick</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">wp_ramification</span>. <span class="tactic">eapply</span> <span class="id">sepconj_imp_l</span>. <span class="id">eexact</span> <span class="id">W</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sepconj_imp_r</span>. 2: <span class="tactic">rewrite</span> <span class="id">sepconj_emp</span>; <span class="id">eexact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
